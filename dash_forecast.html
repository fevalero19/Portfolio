<!DOCTYPE HTML>
<!--
	Spectral by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Felipe Valero analyst</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="index.html">Felipe Valero</a></h1>
						<nav id="nav">
							<ul>
								<li class="special">
									<a href="#menu" class="menuToggle"><span>Menu</span></a>
									<div id="menu">
										<ul>
											<li><a href="index.html">Home</a></li>
											<li><a href="dash_forecast.html">Dashboard for commodity yield forecasting</a></li>
											<li><a href="education.html">Education</a></li>
											<!-- <li><a href="#">Sign Up</a></li> -->
											<!-- <li><a href="#">Log In</a></li> -->
										</ul>
									</div>
								</li>
							</ul>
						</nav>
					</header>

				<!-- Main -->
					<article id="main">
						<header>
							<h2>
							<!-- <img src="https://media.giphy.com/media/xT8qBepJQzUjJ2jKpC/giphy.gif" 
								alt="Under construction"> -->
							<br>
							
							<br>
							Commodity Yield Forecasting Dashboard
							</h2>
							<p>
							See an example of my 
							BI tools proficiency below. Dashboard done with random but realistic data. 
							</p>
						</header>
						<section class="wrapper style5">
							<div class="inner">

								<h3>Aim of this tool</h3>
								This dashboard is designed to support decision-making for commodity traders. 
								It used weather + NDVI data to train and evaluate
								statistical models that forecast annual yields for three commodities.
								

								<h3>How to use it</h3>

<style>
.cocoa-list {
  list-style: none;         /* remove default bullets */
  padding: 0;
  margin: 0;
}

.cocoa-list li {
  position: relative;
  padding-left: 36px;       /* add space for emoji */
  margin: 10px 0;
  line-height: 1.6;         /* improves readability */
  font-family: "Segoe UI", sans-serif;
}

.cocoa-list li::before {
  content: "üç´";
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);  /* vertically center emoji */
  font-size: 22px;
  line-height: 1;
}
</style>

<ul class="cocoa-list">
  <li>Compare models' performance accross: Crop, predictive variable, and geographical unit </li>
  <li> Models used variable's recordings up until the week they were trained. Model on week 40 used information from weeks 18-40 </li>
  <li>Zoom in by using left-click and drag --  zoom out with double left-click</li>
  <li>Shaded regions denote crop stage</li>
</ul>



								<h3>Data disclaimer</h3>

								The data presented here is hypothetical. All data used to train models which output is displayed below </br>
								was generated virtually. However, the randomized data generation was limited to realistic bounds. Generative AI was used to develop this project. </p>

								<!-- ====== Interactive Commodity Yield Forecasting Dashboard (Client-side) ====== -->
								<h2 style="margin-top:2rem;">Interactive Dashboard (Client-side)</h2>
								<p>
									I designed this tool to load data stored in a precomputed CSV file 
									with yield estimation at differen geographical levels. 
									
								</p>

								<!-- Panel A controls -->
								<div id="panel-a" class="dash-panel">
								<h4>Top plot (TEST)</h4>
								<div class="controls">
									<label>Crop
									<select id="crop-a"></select>
									</label>
									<label>Variable
									<select id="var-a"></select>
									</label>
									<label>Aggregation
									<select id="agg-a">
										<option value="municipality">Municipality</option>
										<option value="region">Region</option>
										<option value="state">State</option>
									</select>
									</label>
									<label>Unit
									<select id="unit-a"></select>
									</label>
								</div>
								<div id="chart-a" class="chart"></div>
								</div>

								<hr />

								<!-- Panel B controls -->
								<div id="panel-b" class="dash-panel">
								<h4>Bottom plot (TEST)</h4>
								<div class="controls">
									<label>Crop
									<select id="crop-b"></select>
									</label>
									<label>Variable
									<select id="var-b"></select>
									</label>
									<label>Aggregation
									<select id="agg-b">
										<option value="municipality">Municipality</option>
										<option value="region">Region</option>
										<option value="state">State</option>
									</select>
									</label>
									<label>Unit
									<select id="unit-b"></select>
									</label>
								</div>
								<div id="chart-b" class="chart"></div>
								</div>

								<style>
								/* Dashboardf styling: Minimal styling that blends with HTML5UP theme */
									.dash-panel { margin: 1.5rem 0; }
									.dash-panel .controls {
										display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 10px;
									}
									.dash-panel label { font-weight: 600; color: #111; }

									/* Hide native select arrows & keep theme look */
									.dash-panel select {
										margin-left: 6px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px;
										color: #111; background: #fff;
										appearance: none;           /* Standard */
										-webkit-appearance: none;   /* Chrome/Safari */
										-moz-appearance: none;      /* Firefox */
										background-image: none;     /* Remove any default arrow */
										background-position: right 8px center;
										background-repeat: no-repeat;
									}
									/* Hide IE/Edge legacy arrow */
									.dash-panel select::-ms-expand { display: none; }

									.chart { width: 100%; height: 420px; }
								</style>

							</div>
						</section>
					</article>

				<!-- Footer -->
				<footer id="footer">
					<ul class="icons">
						<!-- 
						<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
						<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
						<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
						<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
						-->
						<li>
							<a href="mailto:felipe.valero98@icloud.com" class="icon solid fa-envelope" title="Contact via email">
								<span class="label">Email</span>
							</a>
						</li>
					</ul>
					<ul class="copyright">
						<li>
							&copy; Felipe Valero 
						</li>
						<li>
							Design adapted from <a href="http://html5up.net" target="_blank" rel="noopener">HTML5 UP</a> template									<span> </span>
						</li>
					</ul>
				</footer>

			</div>

		<!-- Scripts -->
			<!-- Plotly + d3 for client-side CSV loading and plotting -->
			<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
			<script>
				(function() {
				// ---------- CONFIG ----------
				const RELATIVE_CSV_PATH = "data/model_weekly_metrics_and_forecasts.csv";
				const ADD_CACHE_BUSTER = true;  // set to false later if you prefer caching
				// ----------------------------

				// Resolve to an absolute URL so we know EXACTLY where we‚Äôre fetching from
				const baseURL = document.baseURI || window.location.href;
				let CSV_URL = new URL(RELATIVE_CSV_PATH, baseURL).href;
				if (ADD_CACHE_BUSTER) {
					const stamp = Date.now(); // unique each refresh
					CSV_URL += (CSV_URL.includes("?") ? "&" : "?") + "v=" + stamp;
				}

				// Debug: show exactly what/where we‚Äôre loading
				console.log("[Dashboard] Page URL:", baseURL);
				console.log("[Dashboard] Fetching CSV from:", CSV_URL);

				const TEST_ONLY = true; // show only the TEST set

				// Helpers
				const uniq = arr => Array.from(new Set(arr)).sort();
				const toFloat = v => (v === null || v === undefined || v === "" ? NaN : +v);

				function fillSelect(selectEl, values, { pretty = (x)=>x } = {}) {
					selectEl.innerHTML = values.map(v => `<option value="${v}">${pretty(v)}</option>`).join("");
				}
				const prettyCrop = c => c.replace(/_/g, " ").replace(/\b\w/g, m => m.toUpperCase());
				const prettyAgg = a => a.charAt(0).toUpperCase() + a.slice(1);

				function getSeries(df, crop, variable, aggregation, unit) {
					let sub = df.filter(d =>
					d.crop === crop &&
					d.variable === variable &&
					d.aggregation === aggregation &&
					(!unit || d.unit === unit) &&
					(!TEST_ONLY || d.set === "test")
					);

					sub.forEach(d => {
					d.week = +d.week;
					d.mean_pred_yield_t_ha = toFloat(d.mean_pred_yield_t_ha);
					d.r2_adj = Math.max(0, toFloat(d.r2_adj)); // clamp R¬≤ >= 0
					});
					sub.sort((a,b) => a.week - b.week);

					return {
					x: sub.map(d => d.week),
					y_pred: sub.map(d => d.mean_pred_yield_t_ha),
					y_r2: sub.map(d => isFinite(d.r2_adj) ? d.r2_adj : 0),
					title: `${prettyCrop(crop)} | ${variable} | ${prettyAgg(aggregation)} [${unit || "All"}]`
					};
				}
				// --- Crop stage shading helpers (weeks are adjustable) ---
				function buildStageDefs() {
					// Tweak week ranges if you want different stages
					return [
						{ name: "Seeding",     from: 18, to: 24, color: "#8a6708" }, // lightest green
						{ name: "Vegetative",  from: 24, to: 32, color: "#c4b58b" },
						{ name: "Flowering",   from: 32, to: 40, color: "#c8e6c9" },
						{ name: "Pod filling", from: 40, to: 48, color: "#81c784" }  // darkest green
					];
				}

				function buildStageShapes() {
					// Rectangles spanning the plot height (yref: 'paper' covers 0..1)
					return buildStageDefs().map(s => ({
						type: "rect",
						xref: "x",
						yref: "paper",
						x0: s.from,
						x1: s.to,
						y0: 0,
						y1: 1,
						fillcolor: s.color,
						opacity: 0.16,       // nice subtle tint
						line: { width: 0 }   // no borders
					}));
				}

				function buildStageLabels() {
					// Place labels at the top center of each band
					return buildStageDefs().map(s => ({
						xref: "x",
						yref: "paper",
						x: (s.from + s.to) / 2,
						y: 1.07,
						text: s.name,
						showarrow: false,
						font: { size: 14, color: "#000000", family: "inherit" },
						align: "center",
						bgcolor: "rgba(255,255,255,0.0)"
					}));
				}
				// --- Add this small helper (place above drawChart) ---
				function paddedRange(values, padFrac = 0.08, minFloor = null, maxCeil = null) {
					const clean = (values || []).map(Number).filter(v => Number.isFinite(v));
					if (!clean.length) return [0, 1]; // safe fallback
					const min = Math.min(...clean);
					const max = Math.max(...clean);
					if (min === max) {
						// expand a flat range just a bit
						const d = (Math.abs(min) || 1) * padFrac;
						return [min - d, max + d];
					}
					const span = max - min;
					let lo = min - span * padFrac;
					let hi = max + span * padFrac;
					if (minFloor !== null) lo = Math.max(lo, minFloor);
					if (maxCeil  !== null) hi = Math.min(hi, maxCeil);
					return [lo, hi];
				}

				// --- REPLACE your drawChart with this version ---
				function drawChart(containerId, series) {
					const el = document.getElementById(containerId);

					// Compute adaptive ranges from the data shown
					const xRange  = paddedRange(series.x, 0.04);                     // weeks
					const y1Range = paddedRange(series.y_pred, 0.10, 0, null);       // yield ‚â• 0
					const y2Range = paddedRange(series.y_r2,  0.10, 0, 1);           // R¬≤ in [0,1]

					const data = [
						{
						x: series.x,
						y: series.y_pred,
						mode: "lines+markers",
						name: "Predicted yield (t/ha) ‚Äî Test",
						marker: { size: 9 },
						line: { width: 3 },
						hovertemplate: "Week %{x}<br>Yield %{y:.2f} t/ha<extra></extra>",
						yaxis: "y1"
						},
						{
						x: series.x,
						y: series.y_r2,
						mode: "lines+markers",
						name: "Adjusted R¬≤ ‚Äî Test",
						marker: { size: 9 },
						line: { width: 3, dash: "dot" },
						hovertemplate: "Week %{x}<br>Adj. R¬≤ %{y:.2f}<extra></extra>",
						yaxis: "y2"
						}
					];

					const layout = {
						title: series.title,
						margin: { l: 70, r: 70, t: 60, b: 60 },
						height: 520,
						font: { size: 15 },

						// Adaptive zoom to displayed data
						xaxis:  { title: "Week", range: xRange, constrain: "range", fixedrange: false },
						yaxis:  { title: "Predicted Yield (t/ha)", range: y1Range, showgrid: true, zeroline: false, rangemode: "normal" },
						yaxis2: { title: "Adjusted R¬≤", overlaying: "y", side: "right", range: y2Range, showgrid: false, zeroline: false, rangemode: "normal" },

						legend: { orientation: "h", x: 0.5, xanchor: "center", y: -0.20 },

						// Keep your stage shading & labels
						shapes: buildStageShapes(),
						annotations: buildStageLabels()
					};

					// Render with interactive zoom still enabled
					Plotly.react(el, data, layout, { displayModeBar: true, responsive: true });
				}


				function initPanel(df, ids, defaults) {
					const cropSel = document.getElementById(ids.crop);
					const varSel  = document.getElementById(ids.variable);
					const aggSel  = document.getElementById(ids.agg);
					const unitSel = document.getElementById(ids.unit);

					const crops = uniq(df.map(d => d.crop));
					const vars  = uniq(df.map(d => d.variable));
					fillSelect(cropSel, crops, { pretty: prettyCrop });
					fillSelect(varSel, vars);

					aggSel.value = defaults.agg || "municipality";

					function refreshUnits() {
					const agg = aggSel.value;
					const units = uniq(df.filter(d => d.aggregation === agg).map(d => d.unit));
					fillSelect(unitSel, units.length ? units : ["(none)"]);
					unitSel.value = (defaults.unit && units.includes(defaults.unit)) ? defaults.unit : (units[0] || "(none)");
					}
					refreshUnits();

					if (defaults.crop && crops.includes(defaults.crop)) cropSel.value = defaults.crop;
					if (defaults.variable && vars.includes(defaults.variable)) varSel.value = defaults.variable;

					function update() {
					const s = getSeries(df, cropSel.value, varSel.value, aggSel.value, unitSel.value);
					drawChart(ids.chart, s);
					}

					aggSel.addEventListener("change", () => { refreshUnits(); update(); });
					cropSel.addEventListener("change", update);
					varSel.addEventListener("change", update);
					unitSel.addEventListener("change", update);

					update();
				}

				// Robust loader: fetch ‚Üí text ‚Üí d3.csvParse (with fallback if autoType is missing)
				fetch(CSV_URL, { cache: "no-store" })
					.then(resp => {
					console.log("[Dashboard] CSV status:", resp.status, resp.statusText);
					if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
					return resp.text();
					})
					.then(text => {
					// Use d3.csvParse for better error handling
					const parser = (window.d3 && d3.csvParse) ? d3.csvParse : null;
					if (!parser) throw new Error("d3.csvParse not available; check d3 script include.");
					const autoType = (window.d3 && d3.autoType) ? d3.autoType : (d => d); // safe fallback

					const raw = parser(text, autoType);
					console.log("[Dashboard] Parsed rows:", raw.length);

					const df = raw.map(d => ({
						crop: String(d.crop || "").trim(),
						variable: String(d.variable || "").trim(),
						aggregation: String(d.aggregation || "").trim(),
						unit: String(d.unit || "").trim(),
						week: d.week,
						set: String(d.set || "").trim(),
						mean_pred_yield_t_ha: d.mean_pred_yield_t_ha,
						r2_adj: d.r2_adj
					}));

					// Init both panels
					initPanel(df, { crop: "crop-a", variable: "var-a", agg: "agg-a", unit: "unit-a", chart: "chart-a" }, { agg: "municipality" });
					initPanel(df, { crop: "crop-b", variable: "var-b", agg: "agg-b", unit: "unit-b", chart: "chart-b" }, { agg: "region" });
					})
					.catch(err => {
					console.error("[Dashboard] Failed to load or parse CSV:", err);
					const warn = document.createElement("p");
					warn.style.color = "crimson";
					warn.textContent = "Failed to load dashboard data. Check the console for details.";
					document.getElementById("panel-a").appendChild(warn);
					});
				})();
			</script>

			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>