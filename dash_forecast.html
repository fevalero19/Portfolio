<!DOCTYPE HTML>
<!--
	Spectral by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Felipe Valero analyst</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="index.html">Felipe Valero</a></h1>
						<nav id="nav">
							<ul>
								<li class="special">
									<a href="#menu" class="menuToggle"><span>Menu</span></a>
									<div id="menu">
										<ul>
											<li><a href="index.html">Home</a></li>
											<li><a href="dash_forecast.html">Dashboard for commodity yield forecasting</a></li>
											<li><a href="education.html">Education</a></li>
											<!-- <li><a href="#">Sign Up</a></li> -->
											<!-- <li><a href="#">Log In</a></li> -->
										</ul>
									</div>
								</li>
							</ul>
						</nav>
					</header>

				<!-- Main -->
					<article id="main">
						<header>
							<h2>
							<img src="https://media.giphy.com/media/xT8qBepJQzUjJ2jKpC/giphy.gif" 
								alt="Under construction">
							<br>
							üößüë∑‚Äç‚ôÄÔ∏è Under Construction üößüë∑‚Äç‚ôÄÔ∏è
							<br>
							Commodity Yield Forecasting Dashboard
							</h2>
							<p>
							Dashboard done entirely with open-source coding (Python) üêç
							</p>
						</header>
						<section class="wrapper style5">
							<div class="inner">

								<h3>Data disclaimer</h3>
								<p>The data presented here is hypothetical. All data used to train models which output is displayed </br>
								was generated virtually. However, the randomization was limited to realistic commodity yield bounds.</p>

								<!-- ====== Interactive Commodity Yield Forecasting Dashboard (Client-side) ====== -->
								<h3 style="margin-top:2rem;">Interactive Dashboard (Client-side)</h3>
								<p>This tool loads a precomputed CSV and updates the charts entirely in your browser. No server required.</p>

								<!-- Panel A controls -->
								<div id="panel-a" class="dash-panel">
								<h4>Top plot (TEST)</h4>
								<div class="controls">
									<label>Crop
									<select id="crop-a"></select>
									</label>
									<label>Variable
									<select id="var-a"></select>
									</label>
									<label>Aggregation
									<select id="agg-a">
										<option value="municipality">Municipality</option>
										<option value="region">Region</option>
										<option value="state">State</option>
									</select>
									</label>
									<label>Unit
									<select id="unit-a"></select>
									</label>
								</div>
								<div id="chart-a" class="chart"></div>
								</div>

								<hr />

								<!-- Panel B controls -->
								<div id="panel-b" class="dash-panel">
								<h4>Bottom plot (TEST)</h4>
								<div class="controls">
									<label>Crop
									<select id="crop-b"></select>
									</label>
									<label>Variable
									<select id="var-b"></select>
									</label>
									<label>Aggregation
									<select id="agg-b">
										<option value="municipality">Municipality</option>
										<option value="region">Region</option>
										<option value="state">State</option>
									</select>
									</label>
									<label>Unit
									<select id="unit-b"></select>
									</label>
								</div>
								<div id="chart-b" class="chart"></div>
								</div>

								<style>
								/* Dashboardf styling: Minimal styling that blends with HTML5UP theme */
									.dash-panel { margin: 1.5rem 0; }
									.dash-panel .controls {
										display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 10px;
									}
									.dash-panel label { font-weight: 600; color: #111; }

									/* Hide native select arrows & keep theme look */
									.dash-panel select {
										margin-left: 6px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px;
										color: #111; background: #fff;
										appearance: none;           /* Standard */
										-webkit-appearance: none;   /* Chrome/Safari */
										-moz-appearance: none;      /* Firefox */
										background-image: none;     /* Remove any default arrow */
										background-position: right 8px center;
										background-repeat: no-repeat;
									}
									/* Hide IE/Edge legacy arrow */
									.dash-panel select::-ms-expand { display: none; }

									.chart { width: 100%; height: 420px; }
								</style>

							</div>
						</section>
					</article>

				<!-- Footer -->
				<footer id="footer">
					<ul class="icons">
						<!-- 
						<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
						<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
						<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
						<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
						-->
						<li>
							<a href="mailto:felipe.valero98@icloud.com" class="icon solid fa-envelope" title="Contact via email">
								<span class="label">Email</span>
							</a>
						</li>
					</ul>
					<ul class="copyright">
						<li>
							&copy; Felipe Valero 
						</li>
						<li>
							Design adapted from <a href="http://html5up.net" target="_blank" rel="noopener">HTML5 UP</a> template									<span> </span>
						</li>
					</ul>
				</footer>

			</div>

		<!-- Scripts -->
			<!-- Plotly + d3 for client-side CSV loading and plotting -->
			<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
			<script>
				(function() {
				// ---------- CONFIG ----------
				const RELATIVE_CSV_PATH = "data/model_weekly_metrics_and_forecasts.csv";
				const ADD_CACHE_BUSTER = true;  // set to false later if you prefer caching
				// ----------------------------

				// Resolve to an absolute URL so we know EXACTLY where we‚Äôre fetching from
				const baseURL = document.baseURI || window.location.href;
				let CSV_URL = new URL(RELATIVE_CSV_PATH, baseURL).href;
				if (ADD_CACHE_BUSTER) {
					const stamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
					CSV_URL += (CSV_URL.includes("?") ? "&" : "?") + "v=" + stamp;
				}

				// Debug: show exactly what/where we‚Äôre loading
				console.log("[Dashboard] Page URL:", baseURL);
				console.log("[Dashboard] Fetching CSV from:", CSV_URL);

				const TEST_ONLY = true; // show only the TEST set

				// Helpers
				const uniq = arr => Array.from(new Set(arr)).sort();
				const toFloat = v => (v === null || v === undefined || v === "" ? NaN : +v);

				function fillSelect(selectEl, values, { pretty = (x)=>x } = {}) {
					selectEl.innerHTML = values.map(v => `<option value="${v}">${pretty(v)}</option>`).join("");
				}
				const prettyCrop = c => c.replace(/_/g, " ").replace(/\b\w/g, m => m.toUpperCase());
				const prettyAgg = a => a.charAt(0).toUpperCase() + a.slice(1);

				function getSeries(df, crop, variable, aggregation, unit) {
					let sub = df.filter(d =>
					d.crop === crop &&
					d.variable === variable &&
					d.aggregation === aggregation &&
					(!unit || d.unit === unit) &&
					(!TEST_ONLY || d.set === "test")
					);

					sub.forEach(d => {
					d.week = +d.week;
					d.mean_pred_yield_test = toFloat(d.mean_pred_yield_test);
					d.r2_adj = Math.max(0, toFloat(d.r2_adj)); // clamp R¬≤ >= 0
					});
					sub.sort((a,b) => a.week - b.week);

					return {
					x: sub.map(d => d.week),
					y_pred: sub.map(d => d.mean_pred_yield_test),
					y_r2: sub.map(d => isFinite(d.r2_adj) ? d.r2_adj : 0),
					title: `${prettyCrop(crop)} | ${variable} | ${prettyAgg(aggregation)} [${unit || "All"}]`
					};
				}
				// --- Crop stage shading helpers (weeks are adjustable) ---
				function buildStageDefs() {
					// Tweak week ranges if you want different stages
					return [
						{ name: "Seeding",     from: 18, to: 24, color: "#8a6708" }, // lightest green
						{ name: "Vegetative",  from: 24, to: 32, color: "#c4b58b" },
						{ name: "Flowering",   from: 32, to: 40, color: "#c8e6c9" },
						{ name: "Pod filling", from: 40, to: 48, color: "#81c784" }  // darkest green
					];
				}

				function buildStageShapes() {
					// Rectangles spanning the plot height (yref: 'paper' covers 0..1)
					return buildStageDefs().map(s => ({
						type: "rect",
						xref: "x",
						yref: "paper",
						x0: s.from,
						x1: s.to,
						y0: 0,
						y1: 1,
						fillcolor: s.color,
						opacity: 0.16,       // nice subtle tint
						line: { width: 0 }   // no borders
					}));
				}

				function buildStageLabels() {
					// Place labels at the top center of each band
					return buildStageDefs().map(s => ({
						xref: "x",
						yref: "paper",
						x: (s.from + s.to) / 2,
						y: 1.07,
						text: s.name,
						showarrow: false,
						font: { size: 14, color: "#000000", family: "inherit" },
						align: "center",
						bgcolor: "rgba(255,255,255,0.0)"
					}));
				}
				function drawChart(containerId, series) {
					const el = document.getElementById(containerId);
					const data = [
						{
						x: series.x,
						y: series.y_pred,
						mode: "lines+markers",
						name: "Predicted yield (t/ha) ‚Äî Test",
						hovertemplate: "Week %{x}<br>Yield %{y:.2f} t/ha<extra></extra>",
						yaxis: "y1"
						},
						{
						x: series.x,
						y: series.y_r2,
						mode: "lines+markers",
						name: "Adjusted R¬≤ ‚Äî Test",
						hovertemplate: "Week %{x}<br>Adj. R¬≤ %{y:.2f}<extra></extra>",
						yaxis: "y2"
						}
					];

					const layout = {
						title: series.title,
						margin: {l: 60, r: 60, t: 50, b: 50},
						xaxis: { title: "Week (18‚Äì48)" },
						yaxis:  { title: "Predicted Yield (t/ha)", rangemode: "tozero", showgrid: true, zeroline: false },
						yaxis2: { title: "Adjusted R¬≤", overlaying: "y", side: "right", rangemode: "tozero", showgrid: false, zeroline: false },
						legend: { orientation: "h", x: 0.5, xanchor: "center", y: -0.20 },
						height: 420,
						shapes: buildStageShapes(),     // green stage bands
						annotations: buildStageLabels() // labels for each band
					};

					Plotly.react(el, data, layout, {displayModeBar: true, responsive: true});
				}


				function initPanel(df, ids, defaults) {
					const cropSel = document.getElementById(ids.crop);
					const varSel  = document.getElementById(ids.variable);
					const aggSel  = document.getElementById(ids.agg);
					const unitSel = document.getElementById(ids.unit);

					const crops = uniq(df.map(d => d.crop));
					const vars  = uniq(df.map(d => d.variable));
					fillSelect(cropSel, crops, { pretty: prettyCrop });
					fillSelect(varSel, vars);

					aggSel.value = defaults.agg || "municipality";

					function refreshUnits() {
					const agg = aggSel.value;
					const units = uniq(df.filter(d => d.aggregation === agg).map(d => d.unit));
					fillSelect(unitSel, units.length ? units : ["(none)"]);
					unitSel.value = (defaults.unit && units.includes(defaults.unit)) ? defaults.unit : (units[0] || "(none)");
					}
					refreshUnits();

					if (defaults.crop && crops.includes(defaults.crop)) cropSel.value = defaults.crop;
					if (defaults.variable && vars.includes(defaults.variable)) varSel.value = defaults.variable;

					function update() {
					const s = getSeries(df, cropSel.value, varSel.value, aggSel.value, unitSel.value);
					drawChart(ids.chart, s);
					}

					aggSel.addEventListener("change", () => { refreshUnits(); update(); });
					cropSel.addEventListener("change", update);
					varSel.addEventListener("change", update);
					unitSel.addEventListener("change", update);

					update();
				}

				// Robust loader: fetch ‚Üí text ‚Üí d3.csvParse (with fallback if autoType is missing)
				fetch(CSV_URL, { cache: "no-store" })
					.then(resp => {
					console.log("[Dashboard] CSV status:", resp.status, resp.statusText);
					if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
					return resp.text();
					})
					.then(text => {
					// Use d3.csvParse for better error handling
					const parser = (window.d3 && d3.csvParse) ? d3.csvParse : null;
					if (!parser) throw new Error("d3.csvParse not available; check d3 script include.");
					const autoType = (window.d3 && d3.autoType) ? d3.autoType : (d => d); // safe fallback

					const raw = parser(text, autoType);
					console.log("[Dashboard] Parsed rows:", raw.length);

					const df = raw.map(d => ({
						crop: String(d.crop || "").trim(),
						variable: String(d.variable || "").trim(),
						aggregation: String(d.aggregation || "").trim(),
						unit: String(d.unit || "").trim(),
						week: d.week,
						set: String(d.set || "").trim(),
						mean_pred_yield_test: d.mean_pred_yield_test,
						r2_adj: d.r2_adj
					}));

					// Init both panels
					initPanel(df, { crop: "crop-a", variable: "var-a", agg: "agg-a", unit: "unit-a", chart: "chart-a" }, { agg: "municipality" });
					initPanel(df, { crop: "crop-b", variable: "var-b", agg: "agg-b", unit: "unit-b", chart: "chart-b" }, { agg: "region" });
					})
					.catch(err => {
					console.error("[Dashboard] Failed to load or parse CSV:", err);
					const warn = document.createElement("p");
					warn.style.color = "crimson";
					warn.textContent = "Failed to load dashboard data. Check the console for details.";
					document.getElementById("panel-a").appendChild(warn);
					});
				})();
			</script>

			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>